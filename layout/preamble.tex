\usepackage{amsmath, amsthm, amssymb, dsfont, mathdots}
\usepackage{longtable, booktabs}
\usepackage{setspace}
\usepackage[giveninits=true, maxbibnames=99, sortcites=true, backend=biber]{biblatex}
\usepackage{xpatch}

%%% FONTS %%%
\usepackage{fontspec}
\setkomafont{sectioning}{\normalfont\bfseries}      % titles (chapter, section, etc)
\setkomafont{title}{\normalfont\Large\bfseries}			% thesis title
\setkomafont{caption}{\normalfont\small\bfseries}
\setkomafont{captionlabel}{\normalfont\small\bfseries}

% Optional: set custom font families (e.g, XITS family, Libertinus family, Minion Pro/Myriad Pro/Myriad Math)

% \setmainfont{Libertinus Serif} 
% \setkomafont{sectioning}{\normalfont\bfseries\fontspec{Libertinus Sans}}  % no serifs in titles
% \setkomafont{title}{\normalfont\Large\bfseries\fontspec{Libertinus Sans}}  % no serifs in titles
% \usepackage{unicode-math}
% \setmathfont{Libertinus Math} 

%%%%%%%%%%%%%%%

% Continuous footnote numbering
\usepackage{chngcntr}
\counterwithout{footnote}{chapter}

% Centered chapter headings
\renewcommand{\raggedchapter}{\centering}

% Chapter heading margin
\renewcommand*\chapterheadstartvskip{\vspace*{1in}} 

% Turn off headings
\pagestyle{plain}

% Hyphenation
\hyphenation{con-ti-nu-ous}

% Bib files
\addbibresource{references.bib}

% Remove stupid dots in figures
\renewcommand*{\figureformat}{%
  \figurename~\thefigure%
%  \autodot% DELETED
}
\renewcommand*{\tableformat}{%
  \tablename~\thetable%
%  \autodot% DELETED
}

% Adjust spacing in TOC
\makeatletter
\renewcommand*{\@pnumwidth}{2.2em}
\renewcommand*{\@tocrmarg}{3.2em}
\makeatother
\renewcommand{\contentsname}{Table of Contents}

% Create list of appendices
\newcommand\listofloappname{List of Appendices}
\newcommand*{\listofappendices}{\listoftoc{loapp}}
\setuptoc{loapp}{totoc}

% Links and link formatting 
\usepackage[colorlinks,
            linktoc=all,
            linkcolor={blue!50!black}, 
            citecolor={blue!50!black}, 
            urlcolor={red!50!black}]{hyperref}

% Add "Appendices" to toc
\xapptocmd{\appendix}{
	\phantomsection %
	\addcontentsline{toc}{chapter}{Appendices}
}{}{\PatchFailed}

% Add chapter/appendix to correct list
\xpatchcmd{\addchaptertocentry}{%
    \addtocentrydefault{chapter}{#1}{#2}%
  }{%
  	\ifstr{\chapapp}{Appendix}{
		% We are in appendix
	    \ifstr{#1}{}
	      {\addtocentrydefault{chapter}{#1}{#2}} % numbered
	      {\addcontentsline{loapp}{chapter}{\chapapp{} #1. #2}} %unnumbered
  	}{
	    % We are before appendix
	    \ifstr{#1}{}
	      {\addtocentrydefault{chapter}{#1}{#2}}
	      {\addtocentrydefault{chapter}{}{\chapapp{} #1. #2}}
  	}
  }{}{\PatchFailed}

\xpatchcmd{\addsectiontocentry}{%
    \addtocentrydefault{section}{#1}{#2}%
  }{%
  	\ifstr{\chapapp}{Appendix}{
		% We are in appendix
		\addcontentsline{loapp}{section}{\protect\numberline{#1} #2}% numbered
  	}{
	    % We are before appendix
		\addtocentrydefault{section}{#1}{#2}% numbered
  	}
  }{}{\PatchFailed}

\xpatchcmd{\addsubsectiontocentry}{%
    \addtocentrydefault{subsection}{#1}{#2}%
  }{%
  	\ifstr{\chapapp}{Appendix}{
		% We are in appendix
		\addcontentsline{loapp}{subsection}{\protect\numberline{#1} #2}% numbered
  	}{
	    % We are before appendix
		\addtocentrydefault{subsection}{#1}{#2}% numbered
  	}
  }{}{\PatchFailed}

\xpatchcmd{\addsubsubsectiontocentry}{%
    \addtocentrydefault{subsubsection}{#1}{#2}%
  }{%
  	\ifstr{\chapapp}{Appendix}{
		% We are in appendix
		\addcontentsline{loapp}{subsubsection}{\protect\numberline{#1} #2}% numbered
  	}{
	    % We are before appendix
		\addtocentrydefault{subsubsection}{#1}{#2}% numbered
  	}
  }{}{\PatchFailed}


% Control spacing
\xapptocmd{\mainmatter}
{
	\onehalfspacing
}{}{\PatchFailed}
\xapptocmd{\backmatter}
{
	\singlespacing
	\sloppy % to not have overfull hboxes in reference list
}{}{\PatchFailed}


% Tikz
\usepackage{tikz, pgfplots}
\pgfplotsset{compat=newest}
\usetikzlibrary{calc, arrows.meta, shapes.geometric, positioning, scopes, shadows, decorations.markings, external, intersections, fit, patterns}
\newlength{\figurewidth}
\newlength{\figureheight}
% \tikzexternalize[prefix=figures_compiled/]

% Dont externalize todos
\makeatletter
\renewcommand{\todo}[2][]{\tikzexternaldisable\@todo[#1]{#2}\tikzexternalenable}
\makeatother

% Nomenclature
\usepackage[toc,acronym,nonumberlist,subentrycounter]{glossaries}
\makeglossaries
\loadglsentries[main]{layout/acronyms.tex}
% \setkomafont{descriptionlabel}{\normalfont}
\glstocfalse
